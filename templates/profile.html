{% extends 'base.html' %}
{% block content %}
<div class="grid">
  <div class="card">
    <h2>个人设置</h2>
    <p class="muted">管理你的账号安全与头像。</p>
    <h3>更改密码</h3>
    <form method="post" action="/profile/password">
      <label>当前密码</label>
      <input name="old_password" type="password" required />
      <label>新密码</label>
      <input name="new_password" type="password" required />
      <label>确认新密码</label>
      <input name="new_password2" type="password" required />
      <div style="margin-top:12px"><button class="btn" type="submit">更新密码</button></div>
    </form>
  </div>
  <div class="card">
    <h2>头像</h2>
    <p class="muted">最大 1MB，支持 PNG/JPG/WebP。</p>
    {% if avatar_url %}
      <img class="avatar" style="width:80px;height:80px;margin-bottom:12px" src="{{ avatar_url }}" alt="avatar" />
    {% endif %}
    <form method="post" action="/profile/avatar" enctype="multipart/form-data" id="avatarForm">
      <input id="avatarInput" style="display:none" type="file" name="file" accept="image/png,image/jpeg,image/webp" required />
      <div class="row">
        <button class="btn secondary" type="button" id="chooseAvatarBtn">选择文件</button>
        <span id="avatarFilename" class="muted">未选择文件</span>
      </div>
      <div style="margin-top:12px"><button class="btn" type="submit">上传头像</button></div>
    </form>
    {% if avatar_url %}
    <form method="post" action="/profile/avatar/clear" style="margin-top:12px" onsubmit="return confirm('确定清除当前头像？');">
      <button class="btn secondary" type="submit">清除头像</button>
    </form>
    {% endif %}
  </div>
  <div class="card">
    <h2>邮箱</h2>
    <p class="muted">用于接收系统通知邮件（可选）。</p>
    <form method="post" action="/profile/email" class="row">
      <label class="label-inline" for="emailInput">邮箱</label>
      <input id="emailInput" name="email" type="email" value="{{ current_user.email or '' }}" placeholder="you@example.com" style="max-width:320px" />
      <button class="btn" type="submit">保存邮箱</button>
    </form>
  </div>
</div>
<script>
  const chooseBtn = document.getElementById('chooseAvatarBtn');
  const inputEl = document.getElementById('avatarInput');
  const nameEl = document.getElementById('avatarFilename');
  if (chooseBtn && inputEl){
    chooseBtn.addEventListener('click', ()=> inputEl.click());
    inputEl.addEventListener('change', ()=>{
      const f = inputEl.files && inputEl.files[0];
      nameEl.textContent = f ? f.name : '未选择文件';
    });
  }
</script>
{% endblock %}
