{% extends 'base.html' %}
{% block content %}
<div class="card">
  <h2>提交详情 — {{ user.username }} · {{ event.name }}</h2>
  <p class="muted">
    提交时间：{{ sub.created_at }}
  {% if can_view_wp and sub.wp_url %}
    {% set link_text = (sub.wp_url if (sub.wp_url|length <= 40) else '外链') %}
    ｜外链：<a href="{{ sub.wp_url }}" target="_blank" rel="noopener noreferrer nofollow">{{ link_text }}</a>
  {% endif %}
  </p>
  {% if sub.rejected %}
    <div class="row" style="margin-top:6px">
      <span class="status rev">已被驳回</span>
      {% if sub.rejected_reason %}<span class="muted">理由：{{ sub.rejected_reason }}</span>{% endif %}
      {% if current_user and current_user.id == sub.user_id %}
        <a class="btn secondary" href="/submission/{{ sub.id }}/edit">编辑</a>
      {% endif %}
    </div>
  {% endif %}
  {% if current_user and current_user.id == sub.user_id %}
    {% set any_ok = (items | selectattr('approved') | selectattr('revoked', 'equalto', False) | list | length) > 0 %}
    {% if (not any_ok) and (sub.manual_points is none) %}
    <form method="post" action="/submission/{{ sub.id }}/delete" onsubmit="return confirm('确认删除该提交？该操作会移入垃圾箱');">
      <button class="btn warn" type="submit">删除提交</button>
    </form>
    {% endif %}
  {% endif %}
</div>

{% if wp_html %}
<div class="card">
  <h3>解题报告（Markdown 渲染）</h3>
  <div class="md">{{ wp_html|safe }}</div>
</div>
{% endif %}

<div class="card">
  <h3>题目条目</h3>
  <table class="table-cards">
    <thead><tr><th>#</th><th>类别</th><th>题目</th><th>基础分</th><th>状态</th></tr></thead>
    <tbody>
    {% for it in items %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ it.challenge.category }}</td>
        <td>{{ it.challenge.name }}</td>
        <td>{{ it.challenge.base_score }}</td>
        <td>
          {% if not it.approved %}<span class="status pending">待审</span>
          {% elif it.revoked %}<span class="status rev">已撤销</span>
          {% else %}<span class="status ok">已计分</span>{% endif %}
        </td>
      </tr>
    {% else %}
      <tr><td colspan="5" class="muted">无</td></tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
