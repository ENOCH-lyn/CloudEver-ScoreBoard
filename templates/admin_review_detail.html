{% extends 'base.html' %}
{% block content %}
<div class="card">
  <h2>审核 — {{ user.username }} · {{ event.name }}</h2>
  <p class="muted">
    提交时间：{{ sub.created_at }}
    {% if sub.wp_url %}
      {% set link_text = (sub.wp_url if (sub.wp_url|length <= 40) else '外链') %}
      ｜外链：<a href="{{ sub.wp_url }}" target="_blank" rel="noopener noreferrer nofollow">{{ link_text }}</a>
    {% endif %}
    {% if sub.wp_md %}｜<a href="/submission/{{ sub.id }}">查看 Markdown</a>{% endif %}
  </p>
  <div class="row">
    <form method="post" action="/admin/review/{{ sub.id }}/approve_all">
      <button class="btn" type="submit">一键通过所有待审题目</button>
    </form>
    <form method="post" action="/admin/review/{{ sub.id }}/delete" onsubmit="return confirm('确认将此提交移入垃圾箱？');">
      <button class="btn warn" type="submit">删除该提交</button>
    </form>
  </div>
</div>

<div class="card">
  <h3>最终得分</h3>
  <p class="muted">手动设置可覆盖按题目累计的分数；适用于仅提交 WP 的活动或需要人工调整的情况。</p>
  <form class="row" method="post" action="/admin/review/{{ sub.id }}/set_points">
    <label>手动分数</label>
    <input name="manual_points" value="{{ '%.2f' % sub.manual_points if sub.manual_points is not none else '' }}" style="max-width:160px" placeholder="留空表示按题目累计" />
  <button class="btn" type="submit">保存分数</button>
  {% if sub.manual_points is not none %}
  <button class="btn secondary" name="clear" value="1" type="submit">清除手动分数</button>
  {% endif %}
  </form>
</div>

<div class="card">
  <h3>题目列表</h3>
  <table class="table-cards">
    <thead><tr><th>#</th><th>类别</th><th>题目</th><th>基础分</th><th>状态</th><th>操作</th></tr></thead>
    <tbody>
    {% for it in items %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ it.challenge.category }}</td>
        <td>{{ it.challenge.name }}</td>
        <td>{{ it.challenge.base_score }}</td>
        <td>
          {% if not it.approved %}<span class="status pending">待审</span>
          {% elif it.revoked %}<span class="status rev">已撤销</span>
          {% else %}<span class="status ok">已计分</span>{% endif %}
        </td>
        <td class="row">
          {% if not it.approved %}
            <form method="post" action="/admin/review/item/{{ it.id }}/toggle_approve">
              <button class="btn" type="submit">通过</button>
            </form>
          {% endif %}
          {% if it.approved %}
            <form method="post" action="/admin/review/item/{{ it.id }}/toggle_revoke">
              <button class="btn warn" type="submit">{{ '恢复分数' if it.revoked else '撤销分数' }}</button>
            </form>
          {% endif %}
        </td>
      </tr>
    {% else %}
      <tr><td colspan="6" class="muted">该提交暂无题目</td></tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
