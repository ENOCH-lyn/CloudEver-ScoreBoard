{% extends 'base.html' %}
{% block content %}
<div class="row" style="align-items:flex-start">
  {% include 'partials/admin_side_nav.html' %}
  <main style="flex:1">
    <div class="card">
      <h2>发布通知</h2>
      {% if msg %}<div class="muted">{{ msg }}</div>{% endif %}
      <form id="notifyForm" class="col" method="post" action="/admin/notifications/create" onsubmit="return beforeSubmitUsers()" style="position:relative">
        <div class="row" style="align-items:flex-start; gap:20px; position:relative">
          <div class="col" style="flex:1; min-width:260px; position:relative">
            <label>发送目标</label>
            <div class="target-bar" style="display:flex; flex-wrap:wrap; gap:6px; min-height:42px; padding:8px; border:1px solid var(--border); border-radius:10px; background:#f8fafc; cursor:pointer" onclick="toggleUserPanel()">
              <span id="targetPlaceholder" class="muted">点击选择成员（未选=全部成员）</span>
            </div>
            <div id="userPanel" class="panel" style="display:none; position:absolute; top:70px; left:0; right:0; background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:10px; box-shadow:0 6px 20px -4px rgba(0,0,0,.18); z-index:40">
              <div class="row" style="gap:6px; margin-bottom:8px; flex-wrap:wrap">
                <button class="btn secondary" type="button" onclick="selectAllUsers()">全选</button>
                <button class="btn secondary" type="button" onclick="clearAllUsers()">清除</button>
                <button class="btn" type="button" onclick="applySelection()">应用</button>
              </div>
              <div class="list-scroll" style="max-height:300px; overflow:auto; border:1px solid var(--border); border-radius:10px; padding:8px; background:#fff">
                {% for u in users %}
                <label style="display:flex; align-items:center; gap:8px; padding:4px 6px">
                  <input type="checkbox" class="user-check" value="{{ u.id }}" data-name="{{ u.username }}" /> {{ u.username }}
                </label>
                {% endfor %}
              </div>
            </div>
            <input type="hidden" name="user_ids" id="userIds" />
            <label style="margin-top:16px">标题</label>
            <input name="title" placeholder="通知标题" required />
          </div>
          <div class="col" style="flex:2; min-width:320px">
            <label>内容（Markdown 支持）</label>
            <div class="content-wrapper" style="border:1px solid var(--border); border-radius:10px; background:#f8fafc; padding:0; display:flex; flex-direction:column; height:400px">
              <textarea name="content" id="contentBox" style="flex:1; resize:none; border:0; padding:12px; background:transparent; font-family:inherit" placeholder="正文，支持 Markdown" required></textarea>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:14px; gap:10px">
          <button class="btn" type="submit">发布</button>
          <a class="btn secondary" href="/admin/notifications">返回</a>
        </div>
      </form>
    </div>
  </main>
</div>
<script>
  let panelOpen = false;
  const panel = document.getElementById('userPanel');
  const placeholder = document.getElementById('targetPlaceholder');
  function toggleUserPanel(){ panelOpen = !panelOpen; panel.style.display = panelOpen ? 'block' : 'none'; }
  function selectAllUsers(){ document.querySelectorAll('.user-check').forEach(cb=>cb.checked=true); }
  function clearAllUsers(){ document.querySelectorAll('.user-check').forEach(cb=>cb.checked=false); }
  function applySelection(){
    const checked = Array.from(document.querySelectorAll('.user-check')).filter(cb=>cb.checked);
    if (checked.length === 0){ placeholder.textContent = '全部成员'; document.getElementById('userIds').value=''; }
    else {
      document.getElementById('userIds').value = checked.map(cb=>cb.value).join(',');
      placeholder.innerHTML = checked.map(cb=>'<span class="chip">'+cb.dataset.name+'</span>').join('');
    }
    toggleUserPanel();
  }
  function beforeSubmitUsers(){
    const checked = Array.from(document.querySelectorAll('.user-check')).filter(cb=>cb.checked);
    document.getElementById('userIds').value = checked.map(cb=>cb.value).join(',');
    return true;
  }
  document.addEventListener('click', (e)=>{ if(panelOpen && !panel.contains(e.target) && !e.target.closest('.target-bar')){ panelOpen=false; panel.style.display='none'; }});
</script>
{% endblock %}
