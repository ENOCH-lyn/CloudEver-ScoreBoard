{% extends 'base.html' %}
{% block content %}
<div class="grid">
  <div class="card">
    <h2>成员详情 — {{ user.username }}</h2>
    <p class="muted">总条目：{{ total_items }} · 已计分：{{ approved }} · 待审：{{ pending }} · 被撤销：{{ revoked }}</p>
    <div class="row">
      <span class="pill">{{ '主队' if user.team_type=='main' else '子队' }}</span>
      <span class="pill">{{ '管理员' if user.role=='admin' else '成员' }}</span>
    </div>
    {% if current_user.role == 'admin' %}
    <h3 style="margin-top:12px">重置密码</h3>
    <form method="post" action="/admin/users/{{ user.id }}/password" class="row">
      <input name="new_password" type="password" placeholder="新密码(≥6位)" style="max-width:260px" />
      <button class="btn" type="submit">更新密码</button>
    </form>
    <h3>设置头像</h3>
    {% if user.avatar_filename %}
      <img class="avatar" style="width:80px;height:80px;margin-bottom:12px" src="/images/{{ user.avatar_filename }}" alt="avatar" />
    {% endif %}
    <form method="post" action="/admin/users/{{ user.id }}/avatar" enctype="multipart/form-data">
      <input id="adminAvatarInput" style="display:none" type="file" name="file" accept="image/png,image/jpeg,image/webp" required />
      <div class="row">
        <button class="btn secondary" type="button" id="adminChooseAvatar">选择文件</button>
        <span id="adminAvatarFilename" class="muted">未选择文件</span>
      </div>
      <div style="margin-top:12px"><button class="btn" type="submit">上传头像</button></div>
    </form>
    {% if user.avatar_filename %}
    <form method="post" action="/admin/users/{{ user.id }}/avatar/clear" style="margin-top:12px" onsubmit="return confirm('确定清除该成员头像？');">
      <button class="btn secondary" type="submit">清除头像</button>
    </form>
    {% endif %}
    {% endif %}
  </div>
  <div class="card">
    <h3>提交记录</h3>
    <table>
      <thead><tr><th>时间</th><th>活动</th><th>条目</th><th>操作</th></tr></thead>
      <tbody>
      {% for s in subs %}
        <tr>
          <td>{{ s.created_at }}</td>
          <td>{{ s.event.name if s.event else '—' }}</td>
          <td>{{ s.items|length }}</td>
          <td><a class="btn secondary" href="/admin/review/{{ s.id }}">查看</a></td>
        </tr>
      {% else %}
        <tr><td colspan="4" class="muted">暂无提交</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script>
  const adminChoose = document.getElementById('adminChooseAvatar');
  const adminInput = document.getElementById('adminAvatarInput');
  const adminName = document.getElementById('adminAvatarFilename');
  if (adminChoose && adminInput){
    adminChoose.addEventListener('click', ()=> adminInput.click());
    adminInput.addEventListener('change', ()=>{
      const f = adminInput.files && adminInput.files[0];
      adminName.textContent = f ? f.name : '未选择文件';
    });
  }
</script>
{% endblock %}
